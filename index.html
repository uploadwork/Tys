<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login (debug-friendly)</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f7f7f8; margin:0; display:flex; align-items:center; justify-content:center; height:100vh; }
    .box { background:#fff; padding:24px; border-radius:12px; width:320px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    h2 { margin:0 0 12px; color:#7a5cff; text-align:center; }
    input { width:100%; padding:10px 12px; margin:8px 0; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box; }
    button { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:none; background:#7a5cff; color:#fff; font-weight:700; cursor:pointer; }
    .small { font-size:13px; color:#666; text-align:center; margin-top:10px; }
    .demo { background:#27ae60; margin-top:10px; }
    .note { font-size:12px; color:#555; margin-top:6px; background:#f1f1f1; padding:8px; border-radius:6px;}
  </style>
</head>
<body>
  <div class="box">
    <h2>Login</h2>
    <form id="loginForm" autocomplete="off" novalidate>
      <input id="username" name="username" type="text" placeholder="Username" required />
      <input id="password" name="password" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>

    <button id="createDemo" class="demo">Create demo user and Open Dashboard</button>

    <div class="note">
      Open DevTools → Application → Local Storage to inspect keys after login.<br>
      Required created key: <code>user_[username]</code>
    </div>
    <div class="small" id="status"></div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("loginForm");
  const statusEl = document.getElementById("status");
  const demoBtn = document.getElementById("createDemo");

  function setStatus(msg, isError = false) {
    if (!statusEl) return;
    statusEl.textContent = msg;
    statusEl.style.color = isError ? "crimson" : "#3a3a3a";
  }

  function makeUserIfMissing(username) {
    const key = "user_" + username;
    try {
      let userData = JSON.parse(localStorage.getItem(key));
      if (!userData || typeof userData !== "object") {
        userData = {
          balance: 0,
          pendingDeposits: [],
          pendingWithdrawals: [],
          history: [],
          balanceVisible: true,
          currency: "EUR",
          tier: 1
        };
        localStorage.setItem(key, JSON.stringify(userData));
        console.log("Created new user data under", key);
        setStatus("Created new account for " + username);
      } else {
        console.log("User data exists for", key, userData);
        setStatus("Loaded existing account for " + username);
      }
      return true;
    } catch (err) {
      console.error("makeUserIfMissing error:", err);
      setStatus("Storage error: " + err.message, true);
      return false;
    }
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    try {
      const username = (document.getElementById("username").value || "").trim();
      const password = (document.getElementById("password").value || "").trim();

      if (!username || !password) {
        setStatus("Please enter username and password", true);
        return;
      }

      // Save session
      localStorage.setItem("currentUser", username);

      // Ensure user_<username> exists
      const ok = makeUserIfMissing(username);
      if (!ok) return;

      // Redirect to dashboard
      setStatus("Login successful — redirecting...");
      // small timeout to allow localStorage to flush & status to render
      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 350);
    } catch (err) {
      console.error("Login handler error:", err);
      setStatus("Unexpected error: " + err.message, true);
    }
  });

  // Demo button to quickly create a sample user and go to dashboard
  demoBtn.addEventListener("click", () => {
    try {
      const username = "Munet11";
      localStorage.setItem("currentUser", username);
      const key = "user_" + username;
      const demo = {
        balance: 930000,
        pendingDeposits: [
          { amount: 60000, status: "pending", date: new Date().toISOString(), proof: "" }
        ],
        pendingWithdrawals: [
          { amount: 5700, status: "pending", date: new Date().toISOString() }
        ],
        history: [
          { action: "Demo user created", date: new Date().toISOString() }
        ],
        balanceVisible: true,
        currency: "EUR",
        tier: 1
      };
      localStorage.setItem(key, JSON.stringify(demo));
      setStatus("Demo user created — redirecting to dashboard...");
      setTimeout(() => window.location.href = "dashboard.html", 400);
    } catch (err) {
      console.error("Demo create error:", err);
      setStatus("Could not create demo: " + err.message, true);
    }
  });

});
</script>
</body>
</html>
